<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doom 3D - Raycasting Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        #gameCanvas {
            border: 2px solid #333;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #0f0;
            font-size: 14px;
            text-shadow: 2px 2px 4px #000;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border: 1px solid #0f0;
        }

        #instructions {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: #0f0;
            font-size: 12px;
            text-shadow: 2px 2px 4px #000;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border: 1px solid #0f0;
            text-align: center;
        }

        #title {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            color: #f00;
            font-size: 36px;
            font-weight: bold;
            text-shadow: 3px 3px 6px #000;
        }
    </style>
</head>
<body>
    <div id="title">DOOM 3D</div>
    <div id="hud">
        <div>FPS: <span id="fps">0</span></div>
        <div>Posizione: X=<span id="posX">0</span>, Y=<span id="posY">0</span></div>
        <div>Angolo: <span id="angle">0</span>°</div>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div id="instructions">
        WASD o Frecce: Muovi | Mouse: Guarda | Click per catturare mouse | ESC per uscire
    </div>

    <script>
        // Canvas setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Impostazioni canvas
        const SCREEN_WIDTH = 800;
        const SCREEN_HEIGHT = 600;
        canvas.width = SCREEN_WIDTH;
        canvas.height = SCREEN_HEIGHT;

        // Costanti del gioco
        const FOV = Math.PI / 3; // 60 gradi
        const HALF_FOV = FOV / 2;
        const NUM_RAYS = SCREEN_WIDTH;
        const MAX_DEPTH = 20;
        const DELTA_ANGLE = FOV / NUM_RAYS;

        const TILE_SIZE = 64;
        const PLAYER_SPEED = 0.1;
        const ROTATION_SPEED = 0.003;

        // Mappa del gioco (1 = muro, 0 = spazio vuoto, 2-9 = muri colorati)
        const worldMap = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,2,2,2,0,0,0,0,3,3,3,0,0,1],
            [1,0,0,2,0,0,0,0,0,0,0,0,3,0,0,1],
            [1,0,0,2,0,0,0,0,0,0,0,0,3,0,0,1],
            [1,0,0,0,0,0,0,4,4,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,4,4,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,5,0,0,0,0,0,0,0,0,6,0,0,1],
            [1,0,0,5,0,0,0,0,0,0,0,0,6,0,0,1],
            [1,0,0,5,0,0,0,7,7,0,0,0,6,0,0,1],
            [1,0,0,0,0,0,0,7,7,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        const MAP_WIDTH = worldMap[0].length;
        const MAP_HEIGHT = worldMap.length;

        // Colori per i diversi tipi di muri
        const wallColors = {
            1: '#888',  // Grigio
            2: '#f00',  // Rosso
            3: '#00f',  // Blu
            4: '#0f0',  // Verde
            5: '#ff0',  // Giallo
            6: '#f0f',  // Magenta
            7: '#0ff',  // Cyan
            8: '#f80',  // Arancione
            9: '#80f'   // Viola
        };

        // Player state
        const player = {
            x: 2.5,
            y: 2.5,
            angle: 0,
            moveSpeed: PLAYER_SPEED,
            rotSpeed: ROTATION_SPEED
        };

        // Input state
        const keys = {};
        let mouseX = 0;
        let mouseLocked = false;

        // FPS counter
        let lastTime = 0;
        let fps = 0;
        let frameCount = 0;
        let fpsTime = 0;

        // Event listeners
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            if (e.key === 'Escape') {
                document.exitPointerLock();
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = true;
        });

        canvas.addEventListener('click', () => {
            canvas.requestPointerLock();
        });

        document.addEventListener('pointerlockchange', () => {
            mouseLocked = document.pointerLockElement === canvas;
        });

        document.addEventListener('mousemove', (e) => {
            if (mouseLocked) {
                player.angle += e.movementX * player.rotSpeed;
                // Normalizza l'angolo tra 0 e 2*PI
                player.angle = (player.angle + Math.PI * 2) % (Math.PI * 2);
            }
        });

        // Funzione per controllare collisioni
        function isWall(x, y) {
            const mapX = Math.floor(x);
            const mapY = Math.floor(y);

            if (mapX < 0 || mapX >= MAP_WIDTH || mapY < 0 || mapY >= MAP_HEIGHT) {
                return true;
            }

            return worldMap[mapY][mapX] !== 0;
        }

        // Raycasting
        function castRay(angle) {
            let sin_a = Math.sin(angle);
            let cos_a = Math.cos(angle);

            // Inizializza variabili per raycasting
            let depth = 0;
            let wallType = 0;

            // Raycasting
            for (let i = 0; i < MAX_DEPTH; i += 0.02) {
                depth = i;

                let targetX = player.x + depth * cos_a;
                let targetY = player.y + depth * sin_a;

                let mapX = Math.floor(targetX);
                let mapY = Math.floor(targetY);

                if (mapX < 0 || mapX >= MAP_WIDTH || mapY < 0 || mapY >= MAP_HEIGHT) {
                    wallType = 1;
                    break;
                }

                if (worldMap[mapY][mapX] !== 0) {
                    wallType = worldMap[mapY][mapX];
                    break;
                }
            }

            return { depth, wallType };
        }

        // Rendering
        function render() {
            // Clear screen
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);

            // Disegna il cielo
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT / 2);

            // Disegna il pavimento
            ctx.fillStyle = '#222';
            ctx.fillRect(0, SCREEN_HEIGHT / 2, SCREEN_WIDTH, SCREEN_HEIGHT / 2);

            // Cast rays
            for (let ray = 0; ray < NUM_RAYS; ray++) {
                const rayAngle = player.angle - HALF_FOV + (ray * DELTA_ANGLE);
                const { depth, wallType } = castRay(rayAngle);

                // Correzione fish-eye
                const adjustedDepth = depth * Math.cos(player.angle - rayAngle);

                // Calcola altezza della parete
                const wallHeight = (TILE_SIZE / adjustedDepth) * (SCREEN_WIDTH / 2);

                // Calcola posizione verticale
                const wallTop = (SCREEN_HEIGHT / 2) - (wallHeight / 2);
                const wallBottom = (SCREEN_HEIGHT / 2) + (wallHeight / 2);

                // Calcola colore basato su distanza (fog effect)
                const brightness = Math.max(0, 1 - (depth / MAX_DEPTH));
                const baseColor = wallColors[wallType] || '#888';

                // Converti colore e applica brightness
                let r, g, b;
                if (baseColor.length === 4) {
                    r = parseInt(baseColor[1] + baseColor[1], 16);
                    g = parseInt(baseColor[2] + baseColor[2], 16);
                    b = parseInt(baseColor[3] + baseColor[3], 16);
                } else {
                    r = parseInt(baseColor.slice(1, 3), 16);
                    g = parseInt(baseColor.slice(3, 5), 16);
                    b = parseInt(baseColor.slice(5, 7), 16);
                }

                r = Math.floor(r * brightness);
                g = Math.floor(g * brightness);
                b = Math.floor(b * brightness);

                ctx.fillStyle = `rgb(${r},${g},${b})`;
                ctx.fillRect(ray, wallTop, 1, wallHeight);
            }
        }

        // Update game state
        function update(deltaTime) {
            const moveStep = player.moveSpeed * deltaTime;

            // Movimento
            let newX = player.x;
            let newY = player.y;

            if (keys['w'] || keys['arrowup']) {
                newX += Math.cos(player.angle) * moveStep;
                newY += Math.sin(player.angle) * moveStep;
            }
            if (keys['s'] || keys['arrowdown']) {
                newX -= Math.cos(player.angle) * moveStep;
                newY -= Math.sin(player.angle) * moveStep;
            }
            if (keys['a']) {
                newX += Math.sin(player.angle) * moveStep;
                newY -= Math.cos(player.angle) * moveStep;
            }
            if (keys['d']) {
                newX -= Math.sin(player.angle) * moveStep;
                newY += Math.cos(player.angle) * moveStep;
            }

            // Rotazione con frecce (quando mouse non bloccato)
            if (!mouseLocked) {
                if (keys['arrowleft']) {
                    player.angle -= player.rotSpeed * deltaTime;
                }
                if (keys['arrowright']) {
                    player.angle += player.rotSpeed * deltaTime;
                }
            }

            // Applica movimento solo se non c'è collisione
            if (!isWall(newX, player.y)) {
                player.x = newX;
            }
            if (!isWall(player.x, newY)) {
                player.y = newY;
            }

            // Normalizza angolo
            player.angle = (player.angle + Math.PI * 2) % (Math.PI * 2);
        }

        // Update HUD
        function updateHUD() {
            document.getElementById('fps').textContent = fps;
            document.getElementById('posX').textContent = player.x.toFixed(2);
            document.getElementById('posY').textContent = player.y.toFixed(2);
            document.getElementById('angle').textContent = Math.floor(player.angle * 180 / Math.PI);
        }

        // Game loop
        function gameLoop(currentTime) {
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;

            // Calcola FPS
            frameCount++;
            fpsTime += deltaTime;
            if (fpsTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                fpsTime = 0;
            }

            // Update e render
            update(deltaTime);
            render();
            updateHUD();

            requestAnimationFrame(gameLoop);
        }

        // Avvia il gioco
        console.log('DOOM 3D Engine inizializzato!');
        console.log('Premi WASD per muoverti, click per catturare il mouse');
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
